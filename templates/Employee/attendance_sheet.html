{% extends 'base.html' %}
{% block content %}
  {% load static %}

  <style>
    #attendanceSheet {
        border-collapse: collapse;
        width: 80%;
        margin: 30px;
    }

    #attendanceSheet th, #attendanceSheet td {
        border: 1px solid black;
        padding: 8px;
        text-align: center;
    }

    #logButtons {
        margin: 10px;
    }

    #logButtons button {
        padding: 20px;
        background-color: rgb(255, 166, 0);
        color: white;
        border: none;
        cursor: pointer;
    }
  </style>
  <ul class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'attendance_sheet' %}">Dashboard</a></li>
    <li class="breadcrumb-item active"><a href="{% url 'apply_leave' %}">Apply Leave</a></li>
  </ul>
  <h1 style="text-align: center;">Employee Attendance</h1>
  

  <form method="post" action="{% url 'attendance_sheet' %}">
    {% csrf_token %}
    <div id="logButtons">
      {% if not loggedIn %}
        <button class="btn btn-primary" id="loginButton" name="action" value="login">Log In</button>
      {% endif %}
      {% if loggedIn %}
        <button class="btn btn-primary" id="logoutButton" name="action" value="logout">Log Out</button>
      {% endif %}
    </div>
  </form>

  <table id="attendanceSheet">
    <thead>
      <tr>
        <th>Date</th>
        <th>Login Time</th>
        <th>Logout Time</th>
      </tr>
    </thead>
    <tbody id="attendanceData">
      {% for attendance_record in employee_attendance %}
        <tr>
          <td>{{ attendance_record.date }}</td>
          <td>{{ attendance_record.login_time }}</td>
          <td>{{ attendance_record.logout_time }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    const isLoggedIn = {{ loggedIn|yesno:"true,false" }};
    const attendanceData = document.getElementById('attendanceData');
    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');

    function updateUI(action) {
      if (action === 'login') {
        const loginTime = new Date().toLocaleTimeString();
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${new Date().toLocaleDateString()}</td>
          <td>${loginTime}</td>
          <td></td>
        `;
        attendanceData.appendChild(newRow);
        loginButton.style.display = 'none';
        logoutButton.style.display = 'block';
      } else if (action === 'logout') {
        const logoutTime = new Date().toLocaleTimeString();
        const lastRow = attendanceData.lastElementChild;
        if (lastRow) {
          lastRow.children[2].textContent = logoutTime;
        }
        loginButton.style.display = 'block';
        logoutButton.style.display = 'none';
      }
    }

    if (isLoggedIn) {
      loginButton.style.display = 'none';
      logoutButton.style.display = 'block';
    }

    // Disable buttons after logout
    const disableButtons = localStorage.getItem('loggedIn') && attendanceData.children.length > 0;
    loginButton.disabled = disableButtons;
    logoutButton.disabled = disableButtons;

    loginButton.addEventListener('click', function () {
      const confirmLogin = window.confirm('Are you sure you want to log in?');
      if (confirmLogin) {
        updateUI('login');
        localStorage.setItem('loggedIn', 'true');
        // Disable login button after login
        loginButton.disabled = true;
      }
    });

    logoutButton.addEventListener('click', function () {
      const confirmLogout = window.confirm('Are you sure you want to log out?');
      if (confirmLogout) {
        updateUI('logout');
        localStorage.removeItem('loggedIn');
        // Disable logout button after logout
        logoutButton.disabled = true;
      }
    });
  </script>
{% endblock %}
